<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel do Administrador - ADD</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
    :root {
        --energisa-blue: #0097CE;
        --energisa-blue-dark: #0079a6;
        --energisa-orange: #F36F21;
    }

    body {
        background: #f4f6f9;
        font-family: 'Segoe UI', sans-serif;
    }

    .topbar {
        background: var(--energisa-blue);
        color: white;
        padding: 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 4px solid var(--energisa-orange);
    }

    .logout-btn {
        background: var(--energisa-orange);
        border: none;
        color: white;
        padding: 8px 15px;
        border-radius: 6px;
        font-weight: bold;
        transition: 0.3s;
    }
    .logout-btn:hover {
        background: #d95f1c;
    }

    .container {
        max-width: 97%;
        margin-top: 25px;
    }

    .table-container {
        max-height: 750px;
        overflow-y: auto;
        border: 2px solid #ddd;
        border-radius: 6px;
    }

    table td, table th {
        padding: 10px;
        font-size: 0.90rem;
    }

    .filter-card {
        padding: 20px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgb(0 0 0 / 0.15);
    }
</style>
</head>

<body>

<!-- üîµ BARRA SUPERIOR -->
<div class="topbar">
    <h4 class="m-0">Painel do Administrador - Energisa</h4>
    <div>
        <span id="userInfo" class="me-3 fw-bold"></span>
        <button class="logout-btn" onclick="logout()">Sair</button>
    </div>
</div>

<div class="container">

    <p id="status" class="status-msg text-danger"></p>

    <!-- üîé FILTROS -->
    <div class="filter-card mb-4">

        <div class="row">
            <div class="col-md-3">
                <label class="fw-bold">Filtrar por Regional</label>
                <select id="filtroRegional" class="form-select">
                    <option value="">Todas</option>
                    <option>LESTE</option>
                    <option>CENTRO</option>
                    <option>OESTE</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="fw-bold">Filtrar por Polo</label>
                <select id="filtroPolo" class="form-select">
                    <option value="">Todos</option>
                    <option>Jo√£o Pessoa</option><option>Itabaiana</option><option>Mamanguape</option>
                    <option>Borborema</option><option>Campina Grande</option><option>Monteiro</option>
                    <option>Guarabira</option><option>Esperan√ßa</option><option>Itaporanga</option>
                    <option>Sousa</option><option>Patos</option><option>Catol√© do Rocha</option>
                </select>
            </div>

            <div class="col-md-3">
                <label class="fw-bold">Data Inicial</label>
                <input id="dataInicio" type="date" class="form-control">
            </div>

            <div class="col-md-3">
                <label class="fw-bold">Data Final</label>
                <input id="dataFim" type="date" class="form-control">
            </div>
        </div>

        <div class="d-flex justify-content-end mt-3 gap-2">
            <button class="btn btn-primary" onclick="aplicarFiltros()">üîç Aplicar</button>
            <button class="btn btn-secondary" onclick="limparFiltros()">‚ôªÔ∏è Limpar</button>
            <button class="btn btn-success" onclick="baixarXLSX()">‚¨áÔ∏è Baixar XLSX</button>
        </div>
    </div>

    <!-- üßæ TABELA -->
    <div class="table-container">
        <table class="table table-bordered table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th><th>Nome</th><th>Email</th><th>Regional</th><th>Polo</th>
                    <th>Matr√≠cula</th><th>Data Uso</th><th>Tipo Refei√ß√£o</th><th>Hor√°rio</th>
                    <th>Localidade</th><th>GPS</th><th>Sequ√™ncia</th><th>OS/RRSS</th>
                    <th>N¬∫ ADD</th><th>Observa√ß√£o</th>
                </tr>
            </thead>
            <tbody id="tabela"></tbody>
        </table>
    </div>
</div>

<script>
let dados = [];
let dadosFiltrados = [];

/* ================================
    üîê BLOQUEIO DE ADMIN
================================ */

const ADMINS = ["3080117", "10374"];
const matriculaLogin = localStorage.getItem("matricula");

if (!matriculaLogin) {
    window.location.href = "https://pedrofillype14.github.io/login/";
}

if (!ADMINS.includes(matriculaLogin)) {
    alert("Acesso negado!");
    window.location.href = "https://pedrofillype14.github.io/prestacao_de_contas/";
}

document.getElementById("userInfo").innerText =
    "Logado como: " + matriculaLogin;

/* ================================
    LOGOUT
================================ */

function logout() {
    localStorage.removeItem("matricula");
    window.location.href = "https://pedrofillype14.github.io/login/";
}

/* ================================
    CARREGAR DADOS
================================ */

document.addEventListener("DOMContentLoaded", async () => {
    const status = document.getElementById("status");

    try {
        const resp = await fetch("https://long-hall-0aaa.pedro-fillype.workers.dev/buscar-todos");
        dados = await resp.json();
        dadosFiltrados = [...dados];

        if (!Array.isArray(dados) || dados.length === 0) {
            status.innerText = "Nenhum registro encontrado.";
            return;
        }

        status.classList.replace("text-danger", "text-success");
        status.innerText = `‚úÖ ${dados.length} registros carregados com sucesso.`;

        preencherTabela(dadosFiltrados);
    } catch (err) {
        status.innerText = "Erro ao carregar dados: " + err.message;
    }
});

/* ================================
    TABELA
================================ */

function preencherTabela(lista) {
    const tabela = document.getElementById("tabela");
    tabela.innerHTML = "";

    lista.forEach(item => {
        tabela.innerHTML += `
            <tr>
                <td>${item.id}</td><td>${item.nome}</td><td>${item.email}</td>
                <td>${item.regional}</td><td>${item.polo}</td>
                <td>${item.matricula}</td><td>${item.datauso}</td><td>${item.tiporefeicao}</td>
                <td>${item.horario}</td><td>${item.localidade}</td><td>${item.gps}</td>
                <td>${item.sequencia || ""}</td><td>${item.osrrss || ""}</td>
                <td>${item.numeroadd || ""}</td><td>${item.observacao || ""}</td>
            </tr>
        `;
    });
}

/* ================================
    FILTROS
================================ */

function aplicarFiltros() {
    const reg = document.getElementById("filtroRegional").value;
    const polo = document.getElementById("filtroPolo").value;
    const dtInicio = document.getElementById("dataInicio").value;
    const dtFim = document.getElementById("dataFim").value;

    dadosFiltrados = dados.filter(item => {
        if (reg && item.regional !== reg) return false;
        if (polo && item.polo !== polo) return false;
        if (dtInicio && item.datauso < dtInicio) return false;
        if (dtFim && item.datauso > dtFim) return false;
        return true;
    });

    preencherTabela(dadosFiltrados);
}

function limparFiltros() {
    document.getElementById("filtroRegional").value = "";
    document.getElementById("filtroPolo").value = "";
    document.getElementById("dataInicio").value = "";
    document.getElementById("dataFim").value = "";

    dadosFiltrados = [...dados];
    preencherTabela(dadosFiltrados);
}

/* ================================
    EXPORTAR XLSX
================================ */

function baixarXLSX() {
    if (!dadosFiltrados.length) {
        alert("Nenhum dado para exportar.");
        return;
    }

    const ws = XLSX.utils.json_to_sheet(dadosFiltrados);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Registros Filtrados");

    XLSX.writeFile(wb, "registros_ADD_filtrados.xlsx");
}
</script>

</body>
</html>
