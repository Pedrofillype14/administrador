<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Painel do Administrador - ADD</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>

<style>
    body { background: #f8f9fa; }

.container {
    max-width: 95%;
    margin-top: 40px;
}

h2 { display: flex; align-items: gap: 10px; }
h2::before { content: "üìä"; font-size: 1.5rem; }

.table-container {
    max-height: 750px;
    overflow-y: auto;
}

table td, table th {
    padding: 10px 12px;
    font-size: 0.95rem;
}

.status-msg { font-weight: bold; margin-bottom: 15px; }
</style>
</head>

<body>
<div class="container">
    <h2>Painel do Administrador</h2>

    <p id="status" class="status-msg text-danger"></p>

    <div class="d-flex justify-content-between mb-3">
        <button class="btn btn-success" onclick="baixarXLSX()">‚¨áÔ∏è Baixar XLSX</button>
    </div>

    <div class="table-container">
        <table class="table table-bordered table-striped table-hover">
            <thead class="table-dark">
                <tr>
                    <th>ID</th><th>Nome</th><th>Email</th><th>Regional</th><th>Polo</th>
                    <th>Matr√≠cula</th><th>Data Uso</th><th>Tipo Refei√ß√£o</th><th>Hor√°rio</th>
                    <th>Localidade</th><th>GPS</th><th>Sequ√™ncia</th><th>OS/RRSS</th>
                    <th>N¬∫ ADD</th><th>Observa√ß√£o</th>
                </tr>
            </thead>
            <tbody id="tabela"></tbody>
        </table>
    </div>
</div>

<script>
let dados = [];

// ‚≠ê Lista de administradores (pode ter quantos quiser)
const ADMINS = ["3080117", "10374"];

document.addEventListener("DOMContentLoaded", async () => {
    const matricula = localStorage.getItem("matricula");
    const status = document.getElementById("status");

    // üîê Se tentar manipular localStorage, isso garante o bloqueio
    if (!ADMINS.includes(matricula)) {
        status.innerText = "‚ùå Acesso negado. Apenas administradores podem ver esta p√°gina.";
        setTimeout(() => window.location.href = "https://pedrofillype14.github.io/login/", 2500);
        return;
    }

    try {
        const resp = await fetch("https://long-hall-0aaa.pedro-fillype.workers.dev/buscar-todos");
        dados = await resp.json();

        if (!Array.isArray(dados) || dados.length === 0) {
            status.innerText = "Nenhum registro encontrado.";
            return;
        }

        status.classList.replace("text-danger", "text-success");
        status.innerText = `‚úÖ ${dados.length} registros carregados com sucesso.`;

        preencherTabela(dados);

    } catch (err) {
        status.innerText = "Erro ao carregar dados: " + err.message;
    }
});

function preencherTabela(lista) {
    const tabela = document.getElementById("tabela");
    tabela.innerHTML = "";

    lista.forEach(item => {
        tabela.innerHTML += `
            <tr>
                <td>${item.id}</td><td>${item.nome}</td><td>${item.email}</td><td>${item.regional}</td>
                <td>${item.polo}</td><td>${item.matricula}</td><td>${item.datauso}</td><td>${item.tiporefeicao}</td>
                <td>${item.horario}</td><td>${item.localidade}</td><td>${item.gps}</td><td>${item.sequencia || ""}</td>
                <td>${item.osrrss || ""}</td><td>${item.numeroadd || ""}</td><td>${item.observacao || ""}</td>
            </tr>
        `;
    });
}

function baixarXLSX() {
    if (!dados.length) {
        alert("Nenhum dado para exportar.");
        return;
    }

    const ws = XLSX.utils.json_to_sheet(dados);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Registros");

    XLSX.writeFile(wb, "registros_ADD.xlsx");
}
</script>

</body>
</html>
